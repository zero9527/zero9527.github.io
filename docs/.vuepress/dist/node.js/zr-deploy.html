<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js å†™çš„ä¸€ä¸ªå‰ç«¯é¡¹ç›®éƒ¨ç½²å·¥å…· | zero9527çš„å°ç«™</title>
    <meta name="description" content="Just playing around">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.0eba1a71.css" as="style"><link rel="preload" href="/assets/js/app.5ad30cc8.js" as="script"><link rel="preload" href="/assets/js/2.2ae201dd.js" as="script"><link rel="preload" href="/assets/js/15.1de091b8.js" as="script"><link rel="prefetch" href="/assets/js/10.3009213d.js"><link rel="prefetch" href="/assets/js/11.fbedfd21.js"><link rel="prefetch" href="/assets/js/12.9b516911.js"><link rel="prefetch" href="/assets/js/13.6832d89b.js"><link rel="prefetch" href="/assets/js/14.c0d8c8c2.js"><link rel="prefetch" href="/assets/js/16.85809d58.js"><link rel="prefetch" href="/assets/js/17.9ce1b8b1.js"><link rel="prefetch" href="/assets/js/18.ddf3f356.js"><link rel="prefetch" href="/assets/js/19.5a67ff82.js"><link rel="prefetch" href="/assets/js/20.bdb19d86.js"><link rel="prefetch" href="/assets/js/21.79df5e91.js"><link rel="prefetch" href="/assets/js/22.f01f7385.js"><link rel="prefetch" href="/assets/js/23.669c260a.js"><link rel="prefetch" href="/assets/js/24.1733401a.js"><link rel="prefetch" href="/assets/js/25.c9884707.js"><link rel="prefetch" href="/assets/js/26.594be1af.js"><link rel="prefetch" href="/assets/js/27.ed2a5537.js"><link rel="prefetch" href="/assets/js/28.8ba18d13.js"><link rel="prefetch" href="/assets/js/3.addc2e4a.js"><link rel="prefetch" href="/assets/js/4.e892ad38.js"><link rel="prefetch" href="/assets/js/5.2f130325.js"><link rel="prefetch" href="/assets/js/6.b7a78bbb.js"><link rel="prefetch" href="/assets/js/7.3d69bdd7.js"><link rel="prefetch" href="/assets/js/8.926e8c25.js"><link rel="prefetch" href="/assets/js/9.7806405c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0eba1a71.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">zero9527çš„å°ç«™</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://vuepress.vuejs.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/zero9527" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/57c2df4175c4cd72901a8e7e" target="_blank" rel="noopener noreferrer" class="nav-link external">
  æ˜é‡‘
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://vuepress.vuejs.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/zero9527" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/57c2df4175c4cd72901a8e7e" target="_blank" rel="noopener noreferrer" class="nav-link external">
  æ˜é‡‘
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Node.js</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node.js/zr-deploy.html" class="active sidebar-link">Node.js å†™çš„ä¸€ä¸ªå‰ç«¯é¡¹ç›®éƒ¨ç½²å·¥å…·</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#zr-deploy" class="sidebar-link">zr-deploy</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#å‰è¨€" class="sidebar-link">å‰è¨€</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#å·¥å…·ä½¿ç”¨" class="sidebar-link">å·¥å…·ä½¿ç”¨</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#ä¸‹è½½" class="sidebar-link">ä¸‹è½½</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#æ‰§è¡Œ" class="sidebar-link">æ‰§è¡Œ</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#é…ç½®æ–‡ä»¶" class="sidebar-link">é…ç½®æ–‡ä»¶</a></li></ul></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#å·¥å…·è¯´æ˜" class="sidebar-link">å·¥å…·è¯´æ˜</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#ç›®å½•ç»“æ„" class="sidebar-link">ç›®å½•ç»“æ„</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#é¡¹ç›®æ‰“åŒ…" class="sidebar-link">é¡¹ç›®æ‰“åŒ…</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#å¤šä¸ªé¡¹ç›®ç¯å¢ƒ" class="sidebar-link">å¤šä¸ªé¡¹ç›®ç¯å¢ƒ</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#å‹ç¼©æ–‡ä»¶" class="sidebar-link">å‹ç¼©æ–‡ä»¶</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#è¿›åº¦å·¥å…·" class="sidebar-link">è¿›åº¦å·¥å…·</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#util-promisify" class="sidebar-link">util.promisify</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#ssh-è¿æ¥æœåŠ¡å™¨" class="sidebar-link">ssh è¿æ¥æœåŠ¡å™¨</a></li></ul></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#éƒ¨ç½²è„šæœ¬å…¥å£-start" class="sidebar-link">éƒ¨ç½²è„šæœ¬å…¥å£ start</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#æ‰“åŒ…ä»£ç -builddist" class="sidebar-link">æ‰“åŒ…ä»£ç  buildDist</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#å‹ç¼©æ–‡ä»¶-compressdist" class="sidebar-link">å‹ç¼©æ–‡ä»¶ compressDist</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#è¿æ¥æœåŠ¡å™¨-connectserver" class="sidebar-link">è¿æ¥æœåŠ¡å™¨ connectServer</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#éƒ¨ç½²é¡¹ç›®-deploy" class="sidebar-link">éƒ¨ç½²é¡¹ç›® deploy</a></li><li class="sidebar-sub-header"><a href="/node.js/zr-deploy.html#å¤§åŠŸå‘Šæˆ" class="sidebar-link">å¤§åŠŸå‘Šæˆ</a></li></ul></li><li><a href="/node.js/directory-1.html" class="sidebar-link">Node.jsæŠ˜è…¾è®°ä¸€ï¼šè¯»æŒ‡å®šæ–‡ä»¶å¤¹ï¼Œè¾“å‡ºè¯¥æ–‡ä»¶å¤¹çš„æ–‡ä»¶æ ‘</a></li><li><a href="/node.js/directory-2.html" class="sidebar-link">Node.js æŠ˜è…¾è®°ä¸€ï¼ˆæ”¹è¿›ï¼‰ï¼šæ–‡ä»¶å¤¹ç›®å½•æ ‘è·å–</a></li><li><a href="/node.js/cmd-line.html" class="sidebar-link">Node.js æŠ˜è…¾è®°äºŒï¼šå‘½ä»¤è¡Œäº¤äº’</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å°ç¨‹åº</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å…¶ä»–</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="node-js-å†™çš„ä¸€ä¸ªå‰ç«¯é¡¹ç›®éƒ¨ç½²å·¥å…·"><a href="#node-js-å†™çš„ä¸€ä¸ªå‰ç«¯é¡¹ç›®éƒ¨ç½²å·¥å…·" class="header-anchor">#</a> Node.js å†™çš„ä¸€ä¸ªå‰ç«¯é¡¹ç›®éƒ¨ç½²å·¥å…·</h1> <h2 id="zr-deploy"><a href="#zr-deploy" class="header-anchor">#</a> zr-deploy</h2> <p>Web å‰ç«¯é¡¹ç›®éƒ¨ç½²è„šæœ¬</p> <h2 id="å‰è¨€"><a href="#å‰è¨€" class="header-anchor">#</a> å‰è¨€</h2> <p>éƒ¨ç½²æµç¨‹ï¼šï¼ˆæ‰§è¡Œ <code>zr-deploy</code> åï¼‰</p> <ul><li>é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ <code>é…ç½®æ–‡ä»¶ zr-deploy-config.json</code></li> <li>æ‰“åŒ…ï¼šæ‰§è¡Œé…ç½®æ–‡ä»¶çš„ <code>æ‰“åŒ…å‘½ä»¤ buildCommand</code> æ‰“åŒ…é¡¹ç›®</li> <li>å‹ç¼©ï¼šæ‰“åŒ…å®Œæˆåå°†æ–‡ä»¶å‹ç¼© <code>local.distDir -&gt; local.distZip</code></li> <li>è¿æ¥æœåŠ¡å™¨ï¼š<code>node-ssh</code> è¿æ¥æœåŠ¡å™¨</li> <li>ä¸Šä¼ ä»£ç ï¼šä¸Šä¼ æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•ï¼ˆ<code>server.distDir</code>ï¼‰</li> <li><code>server.bakeup</code> <ul><li><code>true</code>: å¤‡ä»½æ—§çš„é¡¹ç›®æ–‡ä»¶</li> <li><code>false</code>: åˆ é™¤æ—§çš„é¡¹ç›®æ–‡ä»¶</li></ul></li> <li>è§£å‹ç¼©é¡¹ç›®æ–‡ä»¶</li> <li>éƒ¨ç½²æˆåŠŸ</li></ul> <p><img src="https://s1.ax1x.com/2020/06/19/NMVyiF.gif" alt="é¢„è§ˆå›¾gif"> <img src="https://s1.ax1x.com/2020/06/20/NQ4HJJ.md.png" alt="é¢„è§ˆå›¾png"></p> <p>ğŸ‘‰<a href="https://s1.ax1x.com/2020/06/19/NMVyiF.gif" target="_blank" rel="noopener noreferrer">é¢„è§ˆå›¾æŒ‚äº†çš„è¯ç‚¹è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>å·²å‘å¸ƒ <code>npm</code>ï¼ŒğŸ‘‰<a href="https://www.npmjs.com/package/zr-deploy" target="_blank" rel="noopener noreferrer">zr-deploy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>æºç  <code>github</code>ï¼ŒğŸ‘‰<a href="https://github.com/zero9527/zr-deploy" target="_blank" rel="noopener noreferrer">zr-deploy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="å·¥å…·ä½¿ç”¨"><a href="#å·¥å…·ä½¿ç”¨" class="header-anchor">#</a> å·¥å…·ä½¿ç”¨</h2> <h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="header-anchor">#</a> ä¸‹è½½</h3> <blockquote><p>æ³¨æ„ åŠ  <code>-g</code>/<code>global</code> ä¸‹è½½åˆ°å…¨å±€ï¼Œä¸ç„¶ä¼šæç¤ºæ‰¾ä¸åˆ°å‘½ä»¤ï¼</p></blockquote> <blockquote><p>è¿™æ ·ä¹Ÿä¸ç”¨æ¯ä¸ªé¡¹ç›®åŠ è¿™ä¸ªä¾èµ–ï¼Œåªè¦è¿›åˆ°é¡¹ç›®ç›®å½•ä¸‹ï¼Œæ·»åŠ é…ç½®æ–‡ä»¶åï¼Œæ‰§è¡Œ <code>zr-deploy</code> å°±èƒ½éƒ¨ç½²äº†</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i -g zr-deploy
</code></pre></div><p>æˆ–</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> global <span class="token function">add</span> zr-deploy
</code></pre></div><p>ç„¶ååœ¨ <strong>é¡¹ç›®æ ¹ç›®å½•</strong> æ–°å»ºé…ç½®æ–‡ä»¶ <code>zr-deploy-config.json</code>ï¼Œ</p> <blockquote><p>è®°ä½ åŠ åˆ° <code>.gitignore</code>ï¼Œä¸è¦æŠŠå®ƒä¸Šä¼ åˆ° <code>github</code> ä¸Šé¢äº†</p></blockquote> <h3 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="header-anchor">#</a> æ‰§è¡Œ</h3> <p>è¿›å…¥é¡¹ç›®ç›®å½•</p> <div class="language-shell extra-class"><pre class="language-shell"><code>zr-deploy
</code></pre></div><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="header-anchor">#</a> é…ç½®æ–‡ä»¶</h3> <ul><li><p><code>local</code></p> <ul><li><code>buildCommand</code>: æ‰“åŒ…å‘½ä»¤</li> <li><code>distDir</code>: æœ¬åœ°æ‰“åŒ…è¾“å‡ºçš„è·¯å¾„</li> <li><code>distZip</code>: å‹ç¼©æ‰“åŒ…æ–‡ä»¶çš„æ–‡ä»¶å</li></ul></li> <li><p><code>server</code></p> <ul><li><code>name</code>: é€‰æ‹©çš„åå­—</li> <li><code>host</code>: æœåŠ¡å™¨ IP</li> <li><code>username</code>: æœåŠ¡å™¨çš„ç™»å½•ç”¨æˆ·å</li> <li><code>password</code>: å¯¹åº”ç”¨æˆ·åçš„å¯†ç </li> <li><code>distDir</code>: é¡¹ç›®è·¯å¾„</li> <li><code>distZipName</code>: ä¸Šä¼ çš„å‹ç¼©æ–‡ä»¶å</li> <li><code>bakeup</code>: æ˜¯å¦å¤‡ä»½æ—§ç›®å½•</li></ul></li></ul> <p><code>zr-deploy-config.json</code> æ ¼å¼å¦‚ä¸‹</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;local&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;buildCommand&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn build&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;distDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./docs&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;distZip&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist.zip&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;server&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æœåŠ¡å™¨1&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.1.1.1&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;distDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/var/www/xxx/xxx&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;distZipName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;bakeup&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;local&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;buildCommand&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn build&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;distDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./docs&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;distZip&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist.zip&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;server&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æœåŠ¡å™¨2&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.2.2.2&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;distDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/var/www/xxx/xxx&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;distZipName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;bakeup&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><h2 id="å·¥å…·è¯´æ˜"><a href="#å·¥å…·è¯´æ˜" class="header-anchor">#</a> å·¥å…·è¯´æ˜</h2> <h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="header-anchor">#</a> ç›®å½•ç»“æ„</h3> <div class="language- extra-class"><pre class="language-text"><code>.
â”œâ”€â”€ CHANGE_LOG.md
â”œâ”€â”€ Description.md
â”œâ”€â”€ README.md
â”œâ”€â”€ README_zh.md
â”œâ”€â”€ __test__
â”‚   â”œâ”€â”€ buildDist.t.js
â”‚   â”œâ”€â”€ compressDist.t.js
â”‚   â”œâ”€â”€ getConfig.t.js
â”‚   â”œâ”€â”€ index.test.js
â”‚   â””â”€â”€ zr-deploy-config.json
â”œâ”€â”€ bin
â”‚   â””â”€â”€ zr-deploy.js
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â””â”€â”€ src
    â”œâ”€â”€ buildDist.js
    â”œâ”€â”€ compressDist.js
    â”œâ”€â”€ deploy.js
    â”œâ”€â”€ getConfig.js
    â”œâ”€â”€ index.js
    â”œâ”€â”€ selectEnv.js
    â””â”€â”€ utils
        â”œâ”€â”€ getTime.js
        â”œâ”€â”€ index.js
        â””â”€â”€ textConsole.js
</code></pre></div><h3 id="é¡¹ç›®æ‰“åŒ…"><a href="#é¡¹ç›®æ‰“åŒ…" class="header-anchor">#</a> é¡¹ç›®æ‰“åŒ…</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/buildDist.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> spawn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  shell<span class="token operator">:</span> process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'win32'</span><span class="token punctuation">,</span> <span class="token comment">// å…¼å®¹windowsç³»ç»Ÿ</span>
  stdio<span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span> <span class="token comment">// æ‰“å°å‘½ä»¤åŸå§‹è¾“å‡º</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="å¤šä¸ªé¡¹ç›®ç¯å¢ƒ"><a href="#å¤šä¸ªé¡¹ç›®ç¯å¢ƒ" class="header-anchor">#</a> å¤šä¸ªé¡¹ç›®ç¯å¢ƒ</h3> <p>ä½¿ç”¨ <a href="https://www.npmjs.com/package/inquirer" target="_blank" rel="noopener noreferrer">inquirer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œä»é…ç½®æ–‡ä»¶ä¸­é€‰æ‹©</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src\selectEnv.js</span>
<span class="token keyword">const</span> inquirer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'inquirer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ
 * @param {*} CONFIG é…ç½®æ–‡ä»¶å†…å®¹
 */</span>
<span class="token keyword">function</span> <span class="token function">selectEnv</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">CONFIG</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> select <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'é€‰æ‹©éƒ¨ç½²çš„æœåŠ¡å™¨'</span><span class="token punctuation">,</span>
      choices<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>server<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> index<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> selectServer <span class="token operator">=</span> <span class="token constant">CONFIG</span><span class="token punctuation">[</span>Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>select<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>selectServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> selectEnv<span class="token punctuation">;</span>
</code></pre></div><h3 id="å‹ç¼©æ–‡ä»¶"><a href="#å‹ç¼©æ–‡ä»¶" class="header-anchor">#</a> å‹ç¼©æ–‡ä»¶</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> <span class="token function">add</span> zip-local
</code></pre></div><h3 id="è¿›åº¦å·¥å…·"><a href="#è¿›åº¦å·¥å…·" class="header-anchor">#</a> è¿›åº¦å·¥å…·</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> <span class="token function">add</span> ora
</code></pre></div><p>è°ƒç”¨ <code>ora</code> è¿”å›å€¼çš„ <code>succeed</code>/<code>fail</code> ä¼šæ›¿æ¢åŸæ¥çš„å‚æ•°å€¼ï¼ˆ<code>loading</code>ï¼‰åœ¨ç»ˆç«¯ä¸Šæ˜¾ç¤º</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'æ­£åœ¨æ‰“åŒ…... \n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
spinner<span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'æ‰“åŒ…å®Œæˆï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
spinner<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'æ‰“åŒ…å¤±è´¥ï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="util-promisify"><a href="#util-promisify" class="header-anchor">#</a> util.promisify</h3> <p>å°†<code>node.js</code> å†…ç½®å‡½æ•°è½¬åŒ–ä¸º <code>Promise</code> å½¢å¼ï¼Œ <code>promisify</code> åŒ…è£…ä¸€ä¸‹ï¼Œæ–¹ä¾¿ä½¿ç”¨ <code>async</code>/<code>await</code>ï¼Œè®°ä½è¦è°ƒç”¨ä¸€ä¸‹ <code>next()</code>ï¼Œç›¸å½“äº <code>Promise.resolve()</code>ï¼Œä¸ç„¶æ˜¯ä¸ä¼šèµ°åˆ°ä¸‹ä¸€æ­¥çš„</p> <blockquote><p>æ³¨æ„ï¼šæ™®é€šå‡½æ•°ï¼ˆé <code>node.js</code> å†…ç½®ï¼‰ä½¿ç”¨ <code>promisify</code>ï¼Œè°ƒç”¨ <code>next</code>ï¼Œä¸ä¼ å‚æ•°æ²¡é—®é¢˜ï¼Œä¼ å‚æ•°ç»™ <code>next(arg)</code> æ—¶ï¼Œä¼šèµ°åˆ° <code>catch</code> å»ï¼Œè·Ÿ æ‰‹åŠ¨ <code>new Promise()</code> å¯¹æ¯”ä¸€ä¸‹ï¼Œå“ªä¸ªæ–¹ä¾¿ä½¿ç”¨å“ªä¸ªå°±æ˜¯äº†</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">buildDist</span><span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> params<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>buildDist<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="ssh-è¿æ¥æœåŠ¡å™¨"><a href="#ssh-è¿æ¥æœåŠ¡å™¨" class="header-anchor">#</a> ssh è¿æ¥æœåŠ¡å™¨</h3> <p>ä½¿ç”¨ <code>node-ssh</code> è¿æ¥æœåŠ¡å™¨</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> <span class="token function">add</span> node-ssh
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src\deploy.js</span>
<span class="token keyword">const</span> node_ssh <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-ssh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">SSH</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">node_ssh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* =================== 3ã€è¿æ¥æœåŠ¡å™¨ =================== */</span>
<span class="token comment">/**
 * è¿æ¥æœåŠ¡å™¨
 * @param {*} params { host, username, password }
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">connectServer</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token constant">SSH</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      spinner<span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      spinner<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">textError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * é€šè¿‡ ssh åœ¨æœåŠ¡å™¨ä¸Šå‘½ä»¤
 * @param {*} cmd shell å‘½ä»¤
 * @param {*} cwd è·¯å¾„
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> cwd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token constant">SSH</span><span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    cwd<span class="token punctuation">,</span>
    <span class="token function">onStderr</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">textError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cmd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, stderrChunk, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="éƒ¨ç½²è„šæœ¬å…¥å£-start"><a href="#éƒ¨ç½²è„šæœ¬å…¥å£-start" class="header-anchor">#</a> éƒ¨ç½²è„šæœ¬å…¥å£ start</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src\index.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * å‰ç«¯è‡ªåŠ¨éƒ¨ç½²é¡¹ç›®è„šæœ¬
 */</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> textTitle<span class="token punctuation">,</span> textInfo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/textConsole'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./getConfig'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> selectEnv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./selectEnv'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> buildDist <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./buildDist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> compressDist <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./compressDist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> deploy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./deploy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* =================== 0ã€è·å–é…ç½® =================== */</span>

<span class="token comment">/* =================== 1ã€é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ =================== */</span>

<span class="token comment">/* =================== 2ã€é¡¹ç›®æ‰“åŒ… =================== */</span>

<span class="token comment">/* =================== 3ã€é¡¹ç›®å‹ç¼© =================== */</span>

<span class="token comment">/* =================== 4ã€è¿æ¥æœåŠ¡å™¨ =================== */</span>

<span class="token comment">/* =================== 5ã€éƒ¨ç½²é¡¹ç›® =================== */</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token constant">CONFIG</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">selectEnv</span><span class="token punctuation">(</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">CONFIG</span><span class="token punctuation">)</span> process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">textTitle</span><span class="token punctuation">(</span><span class="token string">'======== è‡ªåŠ¨éƒ¨ç½²é¡¹ç›® ========'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">textInfo</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>npm<span class="token punctuation">,</span> <span class="token operator">...</span>script<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>local<span class="token punctuation">.</span>buildCommand<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// await buildDist('yarn', ['build']);</span>
  <span class="token keyword">await</span> <span class="token function">buildDist</span><span class="token punctuation">(</span>npm<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>script<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">compressDist</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>local<span class="token punctuation">,</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> start<span class="token punctuation">;</span>
</code></pre></div><h2 id="æ‰“åŒ…ä»£ç -builddist"><a href="#æ‰“åŒ…ä»£ç -builddist" class="header-anchor">#</a> æ‰“åŒ…ä»£ç  buildDist</h2> <p>å¯ä»¥ç”¨ <code>child_process.spawn</code> æ‰§è¡Œ <code>shell</code> å‘½ä»¤ <code>npm/yarn build</code></p> <blockquote><p><code>spawn</code> çš„æ ¼å¼æ˜¯ <code>child_process.spawn(command[, args][, options])</code>ï¼Œä»¥æ•°ç»„çš„å½¢å¼ä¼ å‚</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src\buildDist.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> spawn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> textError<span class="token punctuation">,</span> textSuccess <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/textConsole'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * æ‰§è¡Œè„šæœ¬ spawn çš„å°è£…
 * @param {*} cmd
 * @param {*} params
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">buildDist</span><span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> params<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    shell<span class="token operator">:</span> process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'win32'</span><span class="token punctuation">,</span> <span class="token comment">// å…¼å®¹windowsç³»ç»Ÿ</span>
    stdio<span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span> <span class="token comment">// æ‰“å°å‘½ä»¤åŸå§‹è¾“å‡º</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  build<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">textError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Ã— [script: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cmd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] æ‰“åŒ…å¤±è´¥ï¼\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  build<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">textSuccess</span><span class="token punctuation">(</span><span class="token string">'âˆš æ‰“åŒ…å®Œæˆï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">textError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Ã— æ‰“åŒ…å¤±è´¥ï¼[script: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cmd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¿…ä¼ ï¼Œpromisify å›è°ƒç»§ç»­æ‰§è¡Œåç»­å‡½æ•°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>buildDist<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="å‹ç¼©æ–‡ä»¶-compressdist"><a href="#å‹ç¼©æ–‡ä»¶-compressdist" class="header-anchor">#</a> å‹ç¼©æ–‡ä»¶ compressDist</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src\compressDist.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> zipper <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'zip-local'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> textError <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/textConsole'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolvePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * å‹ç¼©æ‰“åŒ…å¥½çš„é¡¹ç›®
 * @param {*} LOCAL_CONFIG æœ¬åœ°é…ç½®
 * @param {*} next
 */</span>
<span class="token keyword">function</span> <span class="token function">compressDist</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">LOCAL_CONFIG</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> distDir<span class="token punctuation">,</span> distZip <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">LOCAL_CONFIG</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dist <span class="token operator">=</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> distDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dist<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">textError</span><span class="token punctuation">(</span><span class="token string">'Ã— å‹ç¼©å¤±è´¥'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">textError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Ã— æ‰“åŒ…è·¯å¾„ [local.distDir] é…ç½®é”™è¯¯ï¼Œ</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dist<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ä¸å­˜åœ¨ï¼\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'æ­£åœ¨å‹ç¼©...\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    zipper<span class="token punctuation">.</span>sync
      <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>dist<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token function">resolvePath</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> distZip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    spinner<span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'å‹ç¼©å®Œæˆï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">textError</span><span class="token punctuation">(</span><span class="token string">'å‹ç¼©å¤±è´¥ï¼'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>compressDist<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="è¿æ¥æœåŠ¡å™¨-connectserver"><a href="#è¿æ¥æœåŠ¡å™¨-connectserver" class="header-anchor">#</a> è¿æ¥æœåŠ¡å™¨ connectServer</h2> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> <span class="token function">add</span> node-ssh
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src\deploy.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> node_ssh <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-ssh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getTime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/getTime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolvePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> textError<span class="token punctuation">,</span> textInfo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/textConsole'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">SSH</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">node_ssh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* =================== 3ã€è¿æ¥æœåŠ¡å™¨ =================== */</span>
<span class="token comment">/**
 * è¿æ¥æœåŠ¡å™¨
 * @param {*} params { host, username, password }
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">connectServer</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token constant">SSH</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      spinner<span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      spinner<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">textError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * é€šè¿‡ ssh åœ¨æœåŠ¡å™¨ä¸Šå‘½ä»¤
 * @param {*} cmd shell å‘½ä»¤
 * @param {*} cwd è·¯å¾„
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> cwd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token constant">SSH</span><span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    cwd<span class="token punctuation">,</span>
    <span class="token function">onStderr</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">textError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cmd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, stderrChunk, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* =================== 4ã€éƒ¨ç½²é¡¹ç›® =================== */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">LOCAL_CONFIG</span><span class="token punctuation">,</span> <span class="token constant">SERVER_CONFIG</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>deploy<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="éƒ¨ç½²é¡¹ç›®-deploy"><a href="#éƒ¨ç½²é¡¹ç›®-deploy" class="header-anchor">#</a> éƒ¨ç½²é¡¹ç›® deploy</h2> <ul><li>ä¸Šä¼ ä»£ç </li> <li>é…ç½®æ–‡ä»¶å¤¹æƒé™</li> <li>å¤‡ä»½åŸæ¥çš„é¡¹ç›®ï¼ˆ<code>server.bakeup</code> ä¸º <code>true</code>ï¼‰</li> <li>åˆ é™¤åŸæ¥çš„é¡¹ç›®ï¼ˆ<code>server.bakeup</code> ä¸º <code>false</code>ï¼‰</li> <li>è§£å‹ç¼©ä¸Šä¼ çš„é¡¹ç›®å‹ç¼©æ–‡ä»¶</li> <li>è§£å‹ç¼©å®Œæˆåï¼Œåˆ é™¤å‹ç¼©æ–‡ä»¶</li> <li>éƒ¨ç½²æˆåŠŸ</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src\deploy.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> node_ssh <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-ssh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getTime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/getTime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolvePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> textError<span class="token punctuation">,</span> textInfo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/textConsole'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">SSH</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">node_ssh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* =================== 3ã€è¿æ¥æœåŠ¡å™¨ =================== */</span>
<span class="token comment">/**
 * è¿æ¥æœåŠ¡å™¨
 * @param {*} params { host, username, password }
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">connectServer</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * é€šè¿‡ ssh åœ¨æœåŠ¡å™¨ä¸Šå‘½ä»¤
 * @param {*} cmd shell å‘½ä»¤
 * @param {*} cwd è·¯å¾„
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> cwd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">/* =================== 4ã€éƒ¨ç½²é¡¹ç›® =================== */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">LOCAL_CONFIG</span><span class="token punctuation">,</span> <span class="token constant">SERVER_CONFIG</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    host<span class="token punctuation">,</span>
    username<span class="token punctuation">,</span>
    password<span class="token punctuation">,</span>
    distDir<span class="token punctuation">,</span>
    distZipName<span class="token punctuation">,</span>
    bakeup<span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">SERVER_CONFIG</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>distZipName <span class="token operator">||</span> distDir <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">textError</span><span class="token punctuation">(</span><span class="token string">'è¯·æ­£ç¡®é…ç½®zr-deploy-config.json!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è¿æ¥æœåŠ¡å™¨</span>
  <span class="token keyword">await</span> <span class="token function">connectServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> host<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// privateKey: '/home/steel/.ssh/id_rsa'</span>

  <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'æ­£åœ¨éƒ¨ç½²é¡¹ç›®...\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸Šä¼ å‹ç¼©çš„é¡¹ç›®æ–‡ä»¶</span>
    <span class="token keyword">await</span> <span class="token constant">SSH</span><span class="token punctuation">.</span><span class="token function">putFile</span><span class="token punctuation">(</span>
      <span class="token function">resolvePath</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">LOCAL_CONFIG</span><span class="token punctuation">.</span>distZip<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distZipName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.zip</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bakeup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤‡ä»½é‡å‘½ååŸé¡¹ç›®çš„æ–‡ä»¶</span>
      <span class="token keyword">await</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mv </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distZipName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distZipName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        distDir
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ é™¤åŸé¡¹ç›®çš„æ–‡ä»¶</span>
      <span class="token keyword">await</span> <span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distZipName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> distDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä¿®æ”¹æ–‡ä»¶æƒé™</span>
    <span class="token keyword">await</span> <span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">chmod 777 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distZipName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.zip</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> distDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è§£å‹ç¼©ä¸Šä¼ çš„é¡¹ç›®æ–‡ä»¶</span>
    <span class="token keyword">await</span> <span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">unzip ./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distZipName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.zip -d </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distZipName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> distDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åˆ é™¤æœåŠ¡å™¨ä¸Šçš„å‹ç¼©çš„é¡¹ç›®æ–‡ä»¶</span>
    <span class="token keyword">await</span> <span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf ./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distZipName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.zip</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> distDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    spinner<span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'éƒ¨ç½²å®Œæˆï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">textInfo</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">é¡¹ç›®è·¯å¾„: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">textInfo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">textInfo</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spinner<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'é¡¹ç›®éƒ¨ç½²å¤±è´¥ï¼\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">textError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">catch: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>deploy<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="å¤§åŠŸå‘Šæˆ"><a href="#å¤§åŠŸå‘Šæˆ" class="header-anchor">#</a> å¤§åŠŸå‘Šæˆ</h2> <p>æ²¡æœ‰æ„å¤–çš„è¯ï¼Œé€€å‡ºè¿›ç¨‹ï¼Œç„¶åå°±éƒ¨ç½²å¥½äº†</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/vue/uni-app.html" class="prev">
        vue/uni-app ä¹‹ç©ºæ‰‹æ’•æ—¥å†
      </a></span> <span class="next"><a href="/node.js/directory-1.html">
        Node.jsæŠ˜è…¾è®°ä¸€ï¼šè¯»æŒ‡å®šæ–‡ä»¶å¤¹ï¼Œè¾“å‡ºè¯¥æ–‡ä»¶å¤¹çš„æ–‡ä»¶æ ‘
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5ad30cc8.js" defer></script><script src="/assets/js/2.2ae201dd.js" defer></script><script src="/assets/js/15.1de091b8.js" defer></script>
  </body>
</html>
